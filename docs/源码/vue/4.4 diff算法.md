# diff 算法

## Vue2 diff

diff 算法是一种通过同层的树节点进行比较的高效算法，算法的整体策略是：深度优先，同层比较。

- 比较只会在同层级进行, 不会跨层级比较
- 在 diff 比较的过程中，循环从两边向中间比较

整个 diff 算法可以分三步：

1. 两列表两端共四个节点，上下两两比较，找出相同节点
2. 如果第一步找不到，则在旧列表中找新列表的第一个节点
2. 当某一列表遍历完成，处理剩余的节点

### 两端对比

第一步中上下 4 个节点上下比较，共 4 种情况，

<img class="img-mid" src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4371s6xxsj20dy0aqwf4.jpg" style="zoom: 80%;" />



```javascript
if (isUndef(oldStartVnode)) {/* ... */}
else if (isUndef(oldEndVnode)) {/* ... */}
else if (sameVnode(oldStartVnode, newStartVnode)) {/* ... */}
else if (sameVnode(oldEndVnode, newEndVnode)) {/* ... */}
else if (sameVnode(oldStartVnode, newEndVnode)) {/* ... */}
else if (sameVnode(oldEndVnode, newStartVnode)) {/* ... */}
else {/* ... */}
```

### 中间遍历寻找

如果两端没有找到相同节点，则在旧节点中遍历寻找与 newStartVnode 相同的节点

* 如果找到，则将其移动到 oldStartVnode 之前
* 如果没有，则新建节点并放在 oldStartVnode 之前

```javascript
if (isUndef(oldKeyToIdx))
  oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
idxInOld = isDef(newStartVnode.key)
  ? oldKeyToIdx[newStartVnode.key]
  : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
if (isUndef(idxInOld)) { // New element
  createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
} else {
  vnodeToMove = oldCh[idxInOld]
  if (sameVnode(vnodeToMove, newStartVnode)) {
    patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)
    oldCh[idxInOld] = undefined
    canMove && nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
  } else {
    // same key but different element. treat as new element
    createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
  }
}
newStartVnode = newCh[++newStartIdx]
```

### 处理剩余节点

```javascript
if (oldStartIdx > oldEndIdx) {
  addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
} else if (newStartIdx > newEndIdx) {
  removeVnodes(oldCh, oldStartIdx, oldEndIdx)
}
```

## vue3 diff

### 预处理

### source

### 如何移动

### 最长递增子序列

## react diff

## 参考

[React、Vue2、Vue3的三种Diff算法](https://juejin.cn/post/6919376064833667080)