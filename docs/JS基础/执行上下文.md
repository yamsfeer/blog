# 执行上下文 ( Execution Contexts )

执行上下文是对 JavaScript 代码执行环境的抽象，执行上下文有三种：

- 全局执行上下文 ( Global Execution Context )：执行全局代码时创建
- 函数执行上下文 ( Functional Execution Context )：执行函数时创建
- eval 执行上下文 ( Eval Execution Context )：用 eval 函数执行一段代码时创建

JavaScript 的整个执行过程中创建的执行上下文都用一个执行栈 ( execution context stack ) 来维护，它也可被称为函数调用栈。

执行上下文有 8 个组成部分，通常一个执行上下文不会同时包含这 8 个字段。下面的表格介绍各字段的名称和作用。

|       Component       |                           Purpose                            |
| :-------------------: | :----------------------------------------------------------: |
| code evaluation state | 执行、挂起和恢复与此执行上下文相关的代码求值所需的任何状态。主要用于 async 和 generator 函数，记录代码执行的位置 |
|       Function        | 执行函数而创建执行上下文时，值为该函数对象，如果是 Script 或 Module 而创建上下文时，该值为 null |
|         Realm         | 可以理解为全局对象，如 window、global，但不包含 webAPI 等宿主提供的对象 |
|   Script Or Module    |           执行 Script 代码或 Module 代码时的上下文           |
|  LexicalEnvironment   |         词法环境，主要用于记录查找变量以及 this 等值         |
|  VariableEnvironment  |                      用于 var 声明语句                       |
|  PrivateEnvironment   |                    用于 class 的私有变量                     |
|       Generator       |                   用于 Generator 函数执行                    |

## 创建执行上下文的过程

执行上下文的创建可以分为两个阶段：创建阶段 ( creation phase )、执行阶段 ( execution phase )。

创建阶段：

* 创建全局对象 global object 和 Realm 对象 ( 全局执行上下文 )

* 绑定 this ( resolveThisBinding )

  全局执行上下文中，this 指向全局对象；函数执行上下文中，this 的值取决于函数的调用方式。

  resolveThisBinding 的返回值是一个 normal 类型或 throw 类型的 Completion Record。

* 创建词法环境

* 创建变量环境

执行阶段：一行一行执行 JavaScript 代码，如果有函数调用，则创建一个新的函数执行上下文并入栈。

执行上下文的数据结构可以认为是这样的：

```javascript
ExecutionContext: {
  ThisBinding: thisValue,
  LexicalEnvironment: { ... },
  VariableEnvironment: { ... },
}
```

## 词法环境 ( Lexical Environment )

Lexical Environment 和 Variable Environment 的值都是一个 Environment Record 对象。

Environment Record 是一个抽象类，具体有 5 种类型，它们之间的派生关系如下图：

![](http://rt9iekfji.hn-bkt.clouddn.com/008vxvgGgy1h8ilmbbg46j30r907ot93.jpg)

以 Function Environment Record 为例，它的数据结构如下：

| Field Name            | Value                                                        | Meaning                                                      |
| --------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [[ThisValue]]         | an [ECMAScript language value](https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#sec-ecmascript-language-types) | This is the this value used for this invocation of the function. |
| [[ThisBindingStatus]] | lexical, initialized, or uninitialized                       | If the value is lexical, this is an [ArrowFunction](https://tc39.es/ecma262/multipage/ecmascript-language-functions-and-classes.html#prod-ArrowFunction) and does not have a local this value. |
| [[FunctionObject]]    | an Object                                                    | The [function object](https://tc39.es/ecma262/multipage/ecmascript-data-types-and-values.html#function-object) whose invocation caused this [Environment Record](https://tc39.es/ecma262/multipage/executable-code-and-execution-contexts.html#sec-environment-records) to be created. |
| [[NewTarget]]         | an Object or undefined                                       | If this [Environment Record](https://tc39.es/ecma262/multipage/executable-code-and-execution-contexts.html#sec-environment-records) was created by the [[Construct]] internal method, [[NewTarget]] is the value of the [[Construct]] newTarget parameter. Otherwise, its value is undefined. |



```javascript
let a = 20
const b = 30
var c

function multiply(e, f) {
 var g = 20
 return e * f * g
}

c = multiply(20, 30)
```





```javascript
GlobalExectionContext = {
  LexicalEnvironment: {
   	EnvironmentRecord: { //
      Type: "Object",
      // identifierKey: identifierValue,
      [[OuterEnv]]: null
    }
  }
}

FunctionExectionContext = {
  EnvironmentRecord: { // LexicalEnvironment
    Type: "Declarative",
    // 在这里绑定标识符,
    [[OuterEnv]]: <Global or outer function environment reference>
  }
}
```



### Realm

![image-20221122224457158](https://raw.githubusercontent.com/yamsfeer/pic-bed/master/image-20221122224457158.png)



![image-20221122224608513](https://raw.githubusercontent.com/yamsfeer/pic-bed/master/image-20221122224608513.png)
