# Hidden Class

## 对象属性访问

来看一段代码：

```javascript
function Foo() {
	this[100] = 'test-100'
	this[1] = 'test-1'
	this["B"] = 'bar-B'
	this[50] = 'test-50'
	this[9] = 'test-9'
	this[8] = 'test-8'
	this[3] = 'test-3'
	this[5] = 'test-5'
	this["A"] = 'bar-A'
	this["C"] = 'bar-C'
}

var bar = new Foo()
for(key in bar){
  console.log(`index:${key} value:${bar[key]}`)
}
```

这段代码的输出结果为：

```javascript
index:1 value:test-1
index:3 value:test-3
index:5 value:test-5
index:8 value:test-8
index:9 value:test-9
index:50 value:test-50
index:100 value:test-100
index:B value:bar-B
index:A value:bar-A
index:C value:bar-C
```

观察结果，可以看出：

* 数字属性被先打印，且按照数字大小打印

* 字符串属性按代码中顺序打印

ECMAScript 规范中定义了**数字属性应该按照索引值大小升序排列，字符串属性根据创建时的顺序排列。**

V8 把对象中的数字属性称为**排序属性** ( **elements** )，字符串属性称为**常规属性** ( **properties** )。

为了有效提升存储和访问的性能，V8 内部分别使用了两个**线性数据结构**保存 elements 和 properties。

<img class="img-mid" src="https://raw.githubusercontent.com/yamsfeer/pic-bed/master/008i3skNgy1gwaejef67fj30vq0nijsu.jpg" style="zoom: 50%;" />

如果执行索引操作，V8 会先从 elements 属性中按照顺序查找，然后再在 properties 属性中查找，这样就完成一次索引操作。

## 快属性、慢属性

将不同的属性分别保存到 element 和 properties 中，简化了程序的复杂度，但是在查找元素时，却多了一步操作，比如 `obj.prop`，需要先找到 properties ，然后找 prop 属性。

虽然只是一步，但是 JavaScript 中的对象属性访问是非常频繁的，这会影响运行效率。

对此 V8 的策略是：**将部分 properties 直接存储到对象本身**，称为**对象内属性 ( in-object properties )**。

<img class="img-mid" src="https://raw.githubusercontent.com/yamsfeer/pic-bed/master/008i3skNgy1gwaejdypwaj30vq0dm0tl.jpg" style="zoom:67%;" />

对象内属性的数量是固定的，默认是 10 个，超出的将被保存在 properties 中。

<img class="img-mid" src="https://raw.githubusercontent.com/yamsfeer/pic-bed/master/008i3skNgy1gwaejdh2n5j30vq0ocwgb.jpg" style="zoom:50%;" />

## 隐藏类 ( hidden class )

参考以下代码：

```c
struct Point {
  int x;
  int y;
}
Point point;
point.x = 100;
point.y = 200;
```

C语言在创建对象前，已经给出了结构体的定义，编译时会将 x、y 的偏移量写入汇编代码中，访问属性时用偏移量计算会很快。

JavaScript 对象可以在运行时改变，无法确定偏移量，只能根据 element、properties 查找。

V8 对每个对象做了两点假设:

* 创建之后不会添加新属性
* 创建之后不会删除属性

V8 为每个对象创建一个隐藏类 ( map )，map 中记录了:

* 对象的所有属性
* 每个属性相对于对象地址的偏移量

每个对象都有一个 map 属性指向该对象的隐藏类。

```javascript
let point = { x: 100, y: 200 }
```

<img class="img-mid" src="https://raw.githubusercontent.com/yamsfeer/pic-bed/master/e6c9d24egy1h66elj1c06j20v00j4ta2.jpg" style="zoom:40%;" />

有了隐藏类，V8 访问对象属性时，就会先去隐藏类中查找该属性的偏移量，然后在内存中取出属性值，而不需要经历一系列的查找过程，大大提升了查找效率。

### 多个对象共用隐藏类

 如果两个对象形状相同 ( 属性名称、个数、顺序相同 )，V8 就会复用同一个隐藏类。

```javascript
let point = { x: 100, y: 200 }
let point2 = { x: 3, y: 4 }
```

<img class="img-mid" src="https://raw.githubusercontent.com/yamsfeer/pic-bed/master/e6c9d24egy1h66eznnz7pj20ny0i4gm8.jpg" alt="image-20220914203809619" style="zoom:50%;" />

如果两个对象不满足形状相同，就需要另外创建一个隐藏类。

如果对象在运行过程中改变，也会重新创建隐藏类。

*( 属性值的类型改变不会创建新的隐藏类 )*

```javascript
let point = {};

% DebugPrint(point); // 0x2c2a080499ad <Object map = 0x2c2a082022d1>
point.x = 100;
% DebugPrint(point); // 0x2c2a080499ad <Object map = 0x2c2a08207a79>
point.y = 200;
% DebugPrint(point); // 0x2c2a080499ad <Object map = 0x2c2a08207aa1>

point.y = 'abc'; // 改变值类型不会创建新的隐藏类
% DebugPrint(point); // 0x2c2a080499ad <Object map = 0x2c2a08207aa1>
```

因此，为了尽量利用隐藏类，需要：

* 保持对象的属性名称、个数、顺序相同
* 一次性初始化完整对象属性
* 避免使用 delete 方法