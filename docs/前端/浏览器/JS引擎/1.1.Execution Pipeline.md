# Execution Pipeline

![image-20221122224457158](https://raw.githubusercontent.com/yamsfeer/pic-bed/master/image-20221122224457158.png)

## Scanner / Parser

## Interpreter Ignition

### Bytecode

## Compiler Turbofan

## 例子

假设有如下代码保存在文件test.js中。

```javascript
var test = 'GeekTime'
```

这段代码会被转化为 AST。

通过 V8 提供的调试工具 D8 ( Debug for V8 )，可以查看 AST 的结构：

```shell
d8 --print-ast test.js
```

执行命令后，得到 AST 的结构：

```shell
--- AST ---
FUNC at 0
  KIND0
  LITERAL ID 0
  SUSPEND COUNT 0 6 . NAME ""
  INFERRED NAME ""
  DECLS
    VARIABLE (0x7ff0e3022298) (mode = VAR, assigned = true) "test"
  BLOCK NOCOMPLETIONS at -1
    EXPRESSION STATEMENT at 11
      INITat11
        VAR PROXY unallocated (0x7ff0e3022298) (mode = VAR, assigned = true)
        LITERAL "GeekTime"
```

前面提到，在生成 AST 的同时，还会生成作用域，通过 D8 来查看：

```shell
d8 --print-scopes test.js
```

test.js 的代码声明了一个全局变量，可以看到 test 变量被加入到了全局作用域中。

```shell
Global scope:
global { // (0x7fd974022048) (0, 24)
	// will be compiled
	// 1 stack slots
	// temporary vars:
	TEMPORARY .result;  // (0x7fd9740223c8) local[0]
	// local vars:
	VAR test;  // (0x7fd974022298)
}
```

生成 AST 和作用域后，就可以使用解释器生成字节码了。

```shell
d8 --print-bytecode test.js
```

```shell
[generated bytecode for function:  (0x02f7081d3125 <SharedFunctionInfo>)]
Bytecode length: 18
Parameter count 1
Register count 3
Frame size 24
OSR nesting level: 0
Bytecode Age: 0
     0x2f7081d31aa @    0 : 13 00             LdaConstant [0]
     0x2f7081d31ac @    2 : c2                Star1
     0x2f7081d31ad @    3 : 19 fe f8          Mov <closure>, r2
     0x2f7081d31b0 @    6 : 64 4f 01 f9 02    CallRuntime [DeclareGlobals], r1-r2
     0x2f7081d31b5 @   11 : 13 01             LdaConstant [1]
     0x2f7081d31b7 @   13 : 23 02 00          StaGlobal [2], [0]
     0x2f7081d31ba @   16 : 0e                LdaUndefined
     0x2f7081d31bb @   17 : a8                Return
Constant pool (size = 3)
Handler Table (size = 0)
Source Position Table (size = 0)
```

生成字节码后，解释器会执行这段字节码。

如果重复执行了某段代码，监控器会将其标记为热点代码，并提交编译器优化。

D8 可以查看被优化的代码和被反优化的代码。

```shell
d8 --print-opt-source test.js
d8 --print-deopt-stress test.js
```

很明显这段代码过于简单，没有触发 V8 的优化机制。
