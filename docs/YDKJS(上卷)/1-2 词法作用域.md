# 词法作用域

## 词法作用域

我们将“作用域”定义为一套规则，这套规则用来管理引擎如何在当前作用域以及嵌套的子作用域中根据标识符名称进行变量查找。

作用域有两种主要的工作模式：

* **词法作用域**

  这是最为普遍的，被大多数编程语言所采用。

  简单来说，词法作用域就是由写代码时变量写在哪里来决定作用域。

  另外，JavaScript也提供了修改作用域的方法，比如```eval```、```with```。

* **动态作用域**：比如bash脚本、Perl等。

考虑以下代码：

```javascript
function foo(a) { 
  var b = a * 2;
	function bar(c) { 
    console.log( a, b, c );
	}
	bar( b * 3 );
}
foo( 2 ); // 2, 4, 12
```

其作用域可表示为下图，由此可见，代码的写法决定了其作用域。

<img src="https://tva1.sinaimg.cn/large/0081Kckwgy1gmbrhvnk6xj30la0d8abt.jpg" alt="image-20210104165125637" style="zoom:50%;" />

**作用域查找会在找到第一个匹配的标识符时停止**。

在多层的嵌套作用域中可以定义同名的标识符，这叫作“遮蔽效应”(内部的标识符“遮蔽”了外部的标识符)。

抛开遮蔽效应， 作用域查找始终从运行时所处的最内部作用域开始，逐级向外或者说向上进行，直到遇见第一个匹配的标识符为止。

## 用```eval```和```with```修改作用域

### eval

考虑以下代码：

```javascript
function foo(str, a) {
  eval( str ); // 欺骗!
  console.log( a, b );
}
var b = 2;
foo( "var b = 3;", 1 ); // 1, 3
```

**默认情况下，如果 ```eval``` 中所执行的代码包含有一个或多个声明(无论是变量还是函数)，就会对 ```eval``` 所处的词法作用域进行修改。**

**实际上，在严格模式下，eval函数运行时有自己的词法作用域，这意味着它无法修改eval函数所处的作用域。**

```javascript
function foo(str) {
	"use strict";
	eval( str );
	console.log( a ); // ReferenceError: a is not defined
}
foo( "var a = 2" );
```

与```eval```相似的函数：

* ```setTimeout``` 和 ```setInterval``` 函数的第一个参数可以是字符串，字符串的内容可以被解释为一段动态生成的函数代码。

  这些功能已经过时且并不被提倡。不要使用它们!

* ```new Function()``` 函数的行为也很类似，最后一个参数可以接受代码字符串，并将其转化为动态生成的函数。

  这个也要尽量避免使用。

### with

**```eval``` 函数如果接受了含有一个或多个声明的代码，就会修改其所处的词法作用域，**

**而 ```with``` 声明实际上是根据你传递给它的对象凭空创建了一个全新的词法作用域。**

```javascript
var obj = {
  a: 1,
	b: 2
};

// 单调乏味的重复 "obj"
obj.a = 2;
obj.b = 3;

// 简单的快捷方式
with (obj) {
  a = 3;
  b = 4;
}
```

**```with``` 的行为非常令人费解，在严格模式下被禁止。**

### eval 和 with 对性能的影响

* ```eval``` 和``` with``` 会在运行时修改或创建新的作用域，以此来欺骗其他在书写时定义的词法作用域。

* **```JavaScript``` 引擎会在编译阶段进行数项的性能优化。**

  其中有些优化**依赖于能够根据代码的词法进行静态分析，并预先确定所有变量和函数的定义位置**，才能在执行过程中快速找到标识符。

* 如果引擎在代码中发现了 ```eval``` 或 ```with```，那么作用域会变得无法预测。

  最坏情况下，所有的优化都是无意义的，**因此最简单的做法就是不做任何优化**。

* 如果代码中大量使用 ```eval``` 或``` with```，那么运行起来**一定会变得非常慢**。

## 总结

* 词法作用域意思是作用域是**由代码编写时变量声明的位置决定**。

  编译过程的词法阶段基本能知道这些变量的位置，从而在运行时快速找到他们

* ```eval``` 可以**在运行时对作用域进行修改**， ```with``` 可以根据传给它的对象**创建一个新的作用域**。

* **这两个的副作用是引擎无法在编译时对作用域查找进行优化，因为引擎只能谨慎地认为这样的优化是无效的。**

  **使用这其中任何一个机制都将导致代码运行变慢。**

